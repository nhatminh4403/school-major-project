@{
    ViewBag.Title = "Chatbot";
}
<style>
    .message {
        margin-bottom: 5px;
        padding: 5px;
        border-radius: 5px;
    }

    .user {
        text-align: right;
        background-color: #e1f5fe;
        margin-left: 40px;
    }

    .bot {
        text-align: left;
        background-color: #f1f1f1;
        margin-right: 40px;
    }

    .category-list {
        background-color: #f1f1f1;
        padding: 10px;
        border-radius: 5px;
        margin-right: 40px;
        margin-bottom: 10px;
    }

    .category-item {
        display: block;
        padding: 10px 15px;
        margin: 5px 0;
        background-color: white;
        border: 1px solid #1976d2;
        border-radius: 5px;
        color: #1976d2;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s;
        text-align: left;
    }

        .category-item:hover {
            background-color: #1976d2;
            color: white;
        }
</style>
<h2>Chat with our Bot</h2>

<div id="chatbox" style="height: 400px; width: 500px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px;">
    <!-- Chat messages will appear here -->
    <div class="message bot">Bot: Xin chào! Tôi có thể giúp gì cho bạn?</div>
</div>

<div id="userInput">
    <input type="text" id="message" placeholder="Nhập nội dung..." style="width: 400px; padding: 8px;" />
    <button id="sendBtn" style="padding: 8px;">Gửi</button>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {

            // Generate or retrieve a unique session ID for this user session
            let sessionId = localStorage.getItem('chatbotSessionId');
            if (!sessionId) {
                sessionId = generateGuid();
                localStorage.setItem('chatbotSessionId', sessionId);
            }
            console.log("Chat Session ID:", sessionId);

            $('#sendBtn').click(sendMessage);
            $('#message').keypress(function (e) {
                if (e.which === 13) {
                    sendMessage();
                    return false; // Prevents form submission
                }
            });

            function sendMessage() {
                const messageText = $('#message').val().trim();
                if (!messageText) {
                    return;
                }

                appendMessage('user', messageText);
                $('#message').val('');

                sendMessageToBot(messageText);
            }

            function sendMessageToBot(messageText) {
                const chatRequest = {
                    message: messageText,
                    sessionId: sessionId
                };

                // Show a "thinking" message and remove it when the response arrives
                const thinkingMessage = appendMessage('bot', 'Đang suy nghĩ...');

                $.ajax({
                    url: '@Url.Action("SendMessage", "Chatbot")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(chatRequest),
                    success: function (response) {
                        console.log("Response received:", response);
                        thinkingMessage.remove(); // Remove the "thinking..." message

                        if (response && response.replies && response.replies.length > 0) {
                            response.replies.forEach(function(reply) {
                                console.log("Processing reply:", reply);

                                // Check if the reply is a string that starts with '{' indicating it might be JSON
                                if (typeof reply === 'string' && reply.trim().startsWith('{')) {
                                    try {
                                        const parsedReply = JSON.parse(reply);
                                        // Check if the parsed object has a 'richContent' property
                                        if (parsedReply.richContent && Array.isArray(parsedReply.richContent)) {
                                            console.log("Found richContent:", parsedReply.richContent);
                                            renderRichContent(parsedReply.richContent);
                                        } else {
                                           // It was valid JSON but not the rich content we expected
                                           appendMessage('bot', reply);
                                        }
                                    } catch (e) {
                                        console.error("JSON parse error:", e);
                                        // If parsing fails, it's just a regular text message
                                        appendMessage('bot', reply);
                                    }
                                } else {
                                    // It's not a JSON string, so treat it as a plain text reply
                                    appendMessage('bot', reply);
                                }
                            });
                        } else {
                            appendMessage('bot', 'Xin lỗi, tôi không nhận được phản hồi hợp lệ.');
                        }
                    },
                    error: function (xhr, status, error) {
                        thinkingMessage.remove();
                        console.error("Error sending message:", status, error, xhr.responseText);
                        appendMessage('bot', 'Rất tiếc! Đã xảy ra lỗi khi kết nối.');
                    }
                });
            }

            function renderRichContent(richContentArray) {
                console.log("Rendering rich content:", richContentArray);

                // The richContent is an array of sections, iterate over it
                richContentArray.forEach(function(section) {
                    console.log("Processing section:", section);

                    let infoTitle = '';
                    let infoSubtitle = '';
                    let chipOptions = [];

                    // Each section is an array of elements (like 'info', 'chips')
                    if(Array.isArray(section)){
                        section.forEach(function(element) {
                            console.log("Processing element:", element);

                            if (element.type === 'info') {
                                infoTitle = element.title || '';
                                infoSubtitle = element.subtitle || '';
                            }
                            else if (element.type === 'chips' && element.options) {
                                chipOptions = element.options;
                            }
                        });
                    }

                    // If we found any valid content, render it as a list
                    if (infoTitle || infoSubtitle || chipOptions.length > 0) {
                        renderCategoryList(infoTitle, infoSubtitle, chipOptions);
                    }
                });

                $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
            }

            function renderCategoryList(title, subtitle, options) {
                let listHtml = '<div class="message bot">'; // Wrap in a bot message container
                listHtml += '<div class="category-list">';

                if (title) {
                    listHtml += '<strong>' + escapeHtml(title) + '</strong>';
                }
                if (subtitle) {
                    listHtml += '<div style="font-size: 0.9em; margin-bottom: 10px;">' + escapeHtml(subtitle) + '</div>';
                }

                options.forEach(function(option) {
                    // Use a button or styled div for better accessibility and interaction
                    listHtml += '<button class="category-item" data-text="' + escapeHtml(option.text) + '">' +
                                escapeHtml(option.text) +
                                '</button>';
                });

                listHtml += '</div></div>';
                $('#chatbox').append(listHtml);

                // Add a single delegated click handler for efficiency
                $('#chatbox').off('click', '.category-item').on('click', '.category-item', function() {
                    const categoryText = $(this).data('text');
                    appendMessage('user', categoryText); // Show what the user "clicked"
                    sendMessageToBot(categoryText); // Send the selection to the bot
                });
            }

            function appendMessage(sender, text) {
                const messageClass = sender === 'user' ? 'user' : 'bot';
                const safeText = escapeHtml(text);
                const messageDiv = `<div class="message ${messageClass}">${safeText}</div>`;
                $('#chatbox').append(messageDiv);
                $('#chatbox').scrollTop($('#chatbox')[0].scrollHeight);
                return $('#chatbox .message').last(); // Return the element for reference
            }

            function generateGuid() {
                function s4() {
                    return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
                }
                return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
            }

            function escapeHtml(unsafe) {
                if (typeof unsafe !== 'string') {
                    return unsafe;
                }
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

        });
    </script>
}